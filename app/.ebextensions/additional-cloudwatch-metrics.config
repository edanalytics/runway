# This ebextension will create custom metrics for memory and disk usage.
# Graphs can be created to view these metrics on a dashboard with the following defintions.

# {
#     "metrics": [
#         [ { "expression": "SEARCH('{CWAgent,AWSEBEnvironmentName,InstanceId} AWSEBEnvironmentName=\"${BeanstalkEnvName}\" MetricName=\"mem_used_percent\"', 'Average', 60)", "id": "e1", "period": 60 } ]
#     ],
#     "view": "timeSeries",
#     "stacked": false,
#     "region": "${AWS::Region}",
#     "stat": "Average",
#     "period": 60,
#     "title": "EC2 Memory Used %"
# }

# {
#     "metrics": [
#         [ { "expression": "SEARCH('{CWAgent,AWSEBEnvironmentName,InstanceId,device,fstype,path} AWSEBEnvironmentName=\"${BeanstalkEnvName}\"', 'Average', 60)", "id": "e1", "period": 60 } ]
#     ],
#     "view": "timeSeries",
#     "stacked": false,
#     "region": "${AWS::Region}",
#     "stat": "Average",
#     "period": 60,
#     "title": "EC2 Disk Used %"
# }

# Ensure that the elasticbeanstalk-ec2-role includes permission to describe tags.

# - PolicyName: 'CloudWatchAgent'
#   PolicyDocument: 
#     Version: "2012-10-17"
#     Statement: 
#       - Effect: Allow
#         Action: ec2:DescribeTags
#         Resource: '*'

# Amazon Cloudwatch Agent should already be installed on beanstalk servers, but could be installed by uncommenting this config.

# packages:
#   rpm:
#     amazon-cloudwatch-agent: https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm

files:
  "/tmp/amazon-cloudwatch-agent.json":
    mode: "000644"
    owner: root
    group: root
    content: |
      {
        "metrics": {
          "append_dimensions": {
            "InstanceId": "${aws:InstanceId}"
          },
          "metrics_collected": {
            "mem": {
              "measurement": [
                "mem_used_percent"
              ],
              "append_dimensions": {
                "AWSEBEnvironmentName": "__EB_ENV__"
              }
            },
            "disk": {
              "measurement": [
                "disk_used_percent"
              ],
              "resources": [
                "/", "/tmp"
              ],
              "append_dimensions": {
                "AWSEBEnvironmentName": "__EB_ENV__"
              }
            }
          }
        }
      }
container_commands:
  01_prepare_cloudwatch_agent_config:
    command: |
      EB_ENV="$(/opt/elasticbeanstalk/bin/get-config container -k environment_name)"
      sed -i "s/__EB_ENV__/$EB_ENV/g" /tmp/amazon-cloudwatch-agent.json
  02_run_cloudwatch_agent:
    command: |
      amazon-cloudwatch-agent-ctl -a append-config -m ec2 -c file:/tmp/amazon-cloudwatch-agent.json -s